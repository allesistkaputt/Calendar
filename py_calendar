import json
from datetime import datetime, timedelta
from ics import Calendar, Event

DEFAULT_TIME = "09:00"

def set_time(date_obj, time_str=DEFAULT_TIME):
    hour, minute = map(int, time_str.split(":"))
    return date_obj.replace(hour=hour, minute=minute)

def calculate_reminder(date):
    if date.weekday() == 0:  # Monday
        return date - timedelta(days=3)
    return date - timedelta(days=2)

def create_event_file(name, date, release_date, release_type):
    cal = Calendar()
    event = Event()

    prefix = "XXX" if release_type.lower() == "bi-weekly" else "ZZZ"
    formatted_release_date = release_date.strftime("%Y-%m-%d")

    # Include prefix and release date in title
    event.name = f"{prefix}_{formatted_release_date} {name}"

    # Event at 09:00 on reminder date
    reminder_date = calculate_reminder(date)
    event.begin = set_time(reminder_date)

    cal.events.add(event)

    safe_name = name.replace(" ", "_")
    filename = f"{prefix}_{formatted_release_date}_{safe_name}.ics"
    with open(filename, "w") as f:
        f.writelines(cal)

    print(f"Created: {filename}")

def create_release_calendar_from_file(input_file):
    with open(input_file, "r") as f:
        releases = json.load(f)

    # Wrap original processing in a loop over releases
    for data in releases:
        release_type = data["release_type"]
        release_date = datetime.strptime(data["release_date"], "%Y-%m-%d")
        start_uat = datetime.strptime(data["start_uat"], "%Y-%m-%d")
        start_pat = datetime.strptime(data["start_pat"], "%Y-%m-%d")
        pso_date = datetime.strptime(data["pso_date"], "%Y-%m-%d")
        delivery_date = datetime.strptime(data["delivery_date"], "%Y-%m-%d")

        test_report_creation = start_uat
        test_completion_report = pso_date - timedelta(days=2)

        milestones = {
            "Release Date": release_date,
            "Start of UAT": start_uat,
            "Start of PAT": start_pat,
            "PSO": pso_date,
            "Delivery Date": delivery_date,
            "Test Report Creation": test_report_creation,
            "Test Completion Report": test_completion_report,
        }

        if release_type.lower() == "monthly":
            milestones["Requirements Covered"] = start_uat
            milestones["Requirements Completed"] = start_pat

        for name, date in milestones.items():
            create_event_file(name, date, release_date, release_type)

if __name__ == "__main__":
    create_release_calendar_from_file("release_input.json")
